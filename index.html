<html>

<head>
  <title>Club Noise Generator</title>
  <style>
    html,
    body {
      transition: background-color 5s ease;
      zoom: 1.25;
    }

    #input {
      width: 400px;
      max-width: 100%;

      height: 100px;
    }
  </style>
</head>

<body>
  <p>OpenAI API Key:</p>
  <input type="text" id="openai_api_key">

  <p>Your job is to convince the rug merchant to sell his rug to you for $100. Start by saying 'Hi':</p>
  <div id="conversation"></div>
  <textarea id="input"></textarea><br>
  <i>(press enter to submit)</i>
  <p>
    Current asking price: $<span id="askingPrice">200</span><br>
    Current merchant anger level (up to 100): <span id="angerLevel">0</span>
  </p>

  <script src="wizard_orpheus.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search)
    const apiKey = params.get('apiKey');

    document.getElementById('openai_api_key').value = apiKey

    function getAPIKey() {
      return document.getElementById('openai_api_key').value
    }

    let rugMan = new WizardOrpheus(getAPIKey(), `
You are a flamboyant Iranian rug merchant.You are selling a rug for $200.Your
job is to negotiate with the customer to sell the rug for $100. You are very proud, and
talk about the rug as if it is the most valuable thing in the world. You are very proud of
your rug, and you are very proud of your heritage. You are tempermental and get
angry easily, especially if you feel like the offers you are getting are too
low.
        `)

    rugMan.variable('currentPrice', 'The current negotiated price for the rug', 200)
    rugMan.variable('merchantAngerLevel', 'Between 0 and 100, how angry the merchant is. Negotiations are off at 80.', 0)

    rugMan.createUserAction({
      name: 'sendMessage',
      parameters: ['A message from the user to the merchant'],
      howBotShouldHandle: "Respond to the user's message."
    })

    rugMan.botAction('respond', 'Respond to the user', { response: 'sample response' }, data => {
      document.getElementById('conversation').innerHTML += `<p>${data.response}</p> `
      document.getElementById('askingPrice').innerText = data.currentVariables.currentPrice.value
      document.getElementById('angerLevel').innerText = data.currentVariables.merchantAngerLevel.value

      document.body.style.backgroundColor = `rgba(255, 0, 0, ${data.currentVariables.merchantAngerLevel.value * 1.0 / 100})`
    })

    document.getElementById('input').addEventListener('keyup', function (e) {
      if (e.keyCode === 13) { // if the user presses enter
        let userInput = document.getElementById('input').value

        rugMan.sendMessage(userInput)

        document.getElementById('conversation').innerHTML += `<p>${userInput}</p>`
        document.getElementById('input').value = ''
      }
    })

    document.getElementById('openai_api_key').addEventListener('keyup', function (e) {
      rugMan.apiKey = document.getElementById('openai_api_key').value
    })

  </script>
</body>

</html>